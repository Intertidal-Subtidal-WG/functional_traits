---
title: "ks_mca-hcpc_timeseries"
author: "Kate Sheridan"
date: "3/13/2022"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(FactoMineR)
library(factoextra)
library(dplyr)
library(here)

# here filepaths
traits <- here('data', 'clean')
plots <- here('output', '2022march', 'mca')
```

## load in data

```{r}
# all species
algae_imputed_all <- read_csv(here(traits, "20220312_algae_imputed.csv"),
                                 col_select = !1) %>%
  filter(intertidal == 'yes') %>%
  select(!(c(body_size_avg_bin, intertidal,
             calcareous)))

animal_imputed_all <- read_csv(here(traits, "20220312_animal_imputed.csv"),
                                 col_select = !1) %>%
  filter(intertidal == 'yes') %>%
  select(!(c(intertidal)))

# time series
algae_traits <- read_csv(here(traits, "20220314_1982-end_algae.csv")) %>%
  filter(intertidal == 'yes') %>%
  select(!(c(intertidal, body_size_avg_bin)))

animal_traits <- read_csv(here(traits, "20220314_1982-end_animal.csv")) %>%
  filter(intertidal == 'yes') %>%
  select(!(c(intertidal)))

# to load in individual species lists
#animal_1982_1995_traits <- read_csv(here(mcadata, "20220313_1982-1995_animal.csv")) %>%
#  filter(intertidal == 'yes') %>%
#  select(!(c(intertidal)))
#animal_2011_end_traits <- read_csv(here(mcadata, "20220313_2011-end_animal.csv")) %>%
#  filter(intertidal == 'yes') %>%
#  select(!(c(intertidal)))
```

## load in functions

```{r}
# input should be imputed traits, filtered as needed
## note that we're selecting columns automatically here 
## starting with column 3 after the species column; change if not true
# note that only output starting with gg are ggplot objects
appledoreMCAHCPC <- function(traits) {
  # select columns for MCA
  traits <- traits %>% 
    column_to_rownames('species') %>%
    dplyr::select(3:(ncol(traits)-1)) %>%
    mutate(across(.fns = ~ as.factor(.)))
  # run MCA
  mca2 <- MCA(traits, graph = FALSE)
  # prepare data for plotting
  cats=apply(traits, 2, function(x) nlevels(as.factor(x)))
  mca2_vars_df = data.frame(mca2$var$coord, Variable = rep(names(cats), 
                                                         cats))
  mca2_obs_df = data.frame(mca2$ind$coord)
  # plot with lines and vectors
  mcaggplot <- ggplot(data = mca2_obs_df, aes(x = Dim.1, y = Dim.2)) + 
    geom_hline(yintercept = 0, colour = "gray70") + 
    geom_vline(xintercept = 0, colour = "gray70") + 
    geom_point(colour = "gray50", alpha = 0.7) + 
    geom_density2d(colour = "gray80") + 
    geom_text(data = mca2_vars_df, aes(x = Dim.1, y = Dim.2, 
                                     label = rownames(mca2_vars_df), 
                                     colour = Variable)) + 
    ggtitle("MCA plot with FactorMineR") + 
    scale_colour_discrete(name = "Variable") +
    geom_segment(data = mca2_vars_df, aes(x = 0, y = 0, xend = Dim.1, yend = Dim.2), 
               arrow = arrow(length = unit(0.2, "cm")), colour = "black") +
    theme_bw(20)+ xlab ("Dim 1 21.28 %")+ ylab("Dim 2 17.54%")
  # ellipses plot
  plot_ellipses <- plotellipses(mca2)
  # screeplot
  scree2 <- fviz_screeplot(mca2)
  contrib2 <- fviz_contrib(mca2, choice = "var", axes = 1:2, top = 15)
  
  
  # run HCPC
  hcpc2 <- HCPC(mca2, graph = FALSE)
  # hcpc dendrogram
  hcpc_dend <- fviz_dend(hcpc2)
  # hcpc factor map
  hcpc_clust <- fviz_cluster(hcpc2, geom = "point", main = "Factor map")
  
  
  #output
  list(mcaeigen = mca2$eig, mcavar = mca2$var,
       mcaind = mca2$ind,
       clustmembers = hcpc2$desc.ind$para,
       clustervariables = hcpc2$desc.var$category,
       mcaplotraw = plot(mca2), ggmca = mcaggplot,
       ggscreeplot = scree2, ggcontrib = contrib2,
       ellipses = plot_ellipses, ggdendrogram = hcpc_dend,
       ggclusterplot = hcpc_clust)
}
```

## run function example
explore output; use df$ to see all saved plots and summary stats
Any output starting with gg is a ggplot object and can be chained with ggplot functions such as:
`algae_all$ggmca + theme_bw()`
```{r}
algae_all <- appledoreMCAHCPC(algae_imputed_all)
# example view a summary
algae_all$mcaeigen
# example ggplot
algae_all$ggscreeplot + theme_bw()

animal_all <- appledoreMCAHCPC(animal_imputed_all)
```
# set up subsets and run

## Algae

### Timeseries
```{r}
# filter
algae_82_95 <- algae_traits %>%
  filter(year <= 1994 & year >= 1982) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

algae_96_06 <- algae_traits %>%
  filter(year >= 1996 & year < 2007) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

algae_10_end <- algae_traits %>%
  filter(year <= 2011) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

# run mca
mca_algae_82_95 <- appledoreMCAHCPC(algae_82_95)
mca_algae_96_06_mca <- appledoreMCAHCPC(algae_96_06)
mca_algae_10_end <- appledoreMCAHCPC(algae_10_end)
```

### exposed/sheltered

for the time series here it will just be beginning and end

```{r algae-exposedsheltered}
# just exposed v sheltered
algae_exposed <- algae_traits %>%
  filter(position == 'exposed') %>%
  select(!(c(year, transect, position))) %>%
  distinct()

algae_sheltered <- algae_traits %>%
  filter(position == 'sheltered') %>%
  select(!(c(year, transect, position))) %>%
  distinct()

mca_algae_exposed <- appledoreMCAHCPC(algae_exposed)
mca_algae_sheltered <- appledoreMCAHCPC(algae_sheltered)

# exposed v sheltered beginning and end
algae_exposed_start <- algae_traits %>%
  filter(position == 'exposed' & year <= 1994 & year >= 1982) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

algae_sheltered_start <- algae_traits %>%
  filter(position == 'sheltered' & year <= 1994 & year >= 1982) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

algae_exposed_end <- algae_traits %>%
  filter(position == 'exposed' & year <= 2010) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

algae_sheltered_end <- algae_traits %>%
  filter(position == 'sheltered' & year <= 2010) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

mca_algae_exposed_start <- appledoreMCAHCPC(algae_exposed_start)
mca_algae_sheltered_start <- appledoreMCAHCPC(algae_sheltered_start)
mca_algae_exposed_end <- appledoreMCAHCPC(algae_exposed_end)
mca_algae_sheltered_end <- appledoreMCAHCPC(algae_sheltered_end)
```


```{r algae-position-plots}

mca_algae_exposed_start$ggmca
mca_algae_exposed_end$ggmca
mca_algae_sheltered_start$ggmca
mca_algae_sheltered_end$ggmca
mca_algae_exposed$ggmca
mca_algae_sheltered$ggmca

ggsave(here(plots, 'temporary', 'algaeexposed.png'), mca_algae_exposed$ggmca, width = 10)
ggsave(here(plots, 'temporary', 'algaesheltered.png'), mca_algae_sheltered$ggmca, width = 10)

ggsave(here(plots, 'temporary', 'algaeexposed_start.png'), mca_algae_exposed_start$ggmca, width = 10)
ggsave(here(plots, 'temporary', 'algaeexposed_end.png'), mca_algae_exposed_end$ggmca, width = 10)

ggsave(here(plots, 'temporary', 'algaesheltered_start.png'), mca_algae_sheltered_start$ggmca, width = 10)
ggsave(here(plots, 'temporary', 'algaesheltered_end.png'), mca_algae_sheltered_end$ggmca, width = 10)

```






## Animals

### Timeseries
```{r}
# filter
animal_82_95 <- animal_traits %>%
  filter(year <= 1994 & year >= 1982) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

animal_96_06 <- animal_traits %>%
  filter(year >= 1996 & year < 2007) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

animal_10_end <- animal_traits %>%
  filter(year <= 2011) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

# run mca
mca_animal_82_95 <- appledoreMCAHCPC(animal_82_95)
mca_animal_96_06_mca <- appledoreMCAHCPC(animal_96_06)
mca_animal_10_end <- appledoreMCAHCPC(animal_10_end)
```

### exposed/sheltered

for the time series here it will just be beginning and end

```{r animal-exposedsheltered}
# just exposed v sheltered
animal_exposed <- animal_traits %>%
  filter(position == 'exposed') %>%
  select(!(c(year, transect, position))) %>%
  distinct()

animal_sheltered <- animal_traits %>%
  filter(position == 'sheltered') %>%
  select(!(c(year, transect, position))) %>%
  distinct()

mca_animal_exposed <- appledoreMCAHCPC(animal_exposed)
mca_animal_sheltered <- appledoreMCAHCPC(animal_sheltered)

# exposed v sheltered beginning and end
animal_exposed_start <- animal_traits %>%
  filter(position == 'exposed' & year <= 1994 & year >= 1982) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

animal_sheltered_start <- animal_traits %>%
  filter(position == 'sheltered' & year <= 1994 & year >= 1982) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

animal_exposed_end <- animal_traits %>%
  filter(position == 'exposed' & year <= 2010) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

animal_sheltered_end <- animal_traits %>%
  filter(position == 'sheltered' & year <= 2010) %>%
  select(!(c(year, transect, position))) %>%
  distinct()

mca_animal_exposed_start <- appledoreMCAHCPC(animal_exposed_start)
mca_animal_sheltered_start <- appledoreMCAHCPC(animal_sheltered_start)
mca_animal_exposed_end <- appledoreMCAHCPC(animal_exposed_end)
mca_animal_sheltered_end <- appledoreMCAHCPC(animal_sheltered_end)
```


```{r animal-position-plots}

mca_animal_exposed_start$ggmca
mca_animal_exposed_end$ggmca
mca_animal_sheltered_start$ggmca
mca_animal_sheltered_end$ggmca
mca_animal_exposed$ggmca
mca_animal_sheltered$ggmca


ggsave(here(plots, 'temporary', 'animalexposed_start.png'), mca_animal_exposed_start$ggmca, width = 10)
ggsave(here(plots, 'temporary', 'animalexposed_end.png'), mca_animal_exposed_end$ggmca, width = 10)

ggsave(here(plots, 'temporary', 'animalsheltered_start.png'), mca_animal_sheltered_start$ggmca, width = 10)
ggsave(here(plots, 'temporary', 'animalsheltered_end.png'), mca_animal_sheltered_end$ggmca, width = 10)

```

